# =============================================================================
# ADVANCED INGRESS WITH TLS, RATE LIMITING, AND AUTHENTICATION
# =============================================================================
# This example demonstrates:
# - NGINX Ingress Controller configuration
# - TLS/SSL termination with cert-manager
# - Rate limiting and request throttling
# - Basic authentication
# - CORS configuration
# - Custom headers and security policies
# =============================================================================

apiVersion: v1
kind: Namespace
metadata:
  name: api-gateway
  labels:
    name: api-gateway

---
# =============================================================================
# TLS CERTIFICATE (CERT-MANAGER)
# =============================================================================
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-tls-cert
  namespace: api-gateway
spec:
  secretName: api-tls-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: api.yourdomain.com
  dnsNames:
    - api.yourdomain.com
    - www.api.yourdomain.com
  privateKey:
    algorithm: RSA
    size: 4096

---
# =============================================================================
# CLUSTER ISSUER FOR CERT-MANAGER
# =============================================================================
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@yourdomain.com
    privateKeySecretRef:
      name: letsencrypt-prod-key
    solvers:
      - http01:
          ingress:
            class: nginx

---
# =============================================================================
# BASIC AUTH SECRET
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth
  namespace: api-gateway
type: Opaque
data:
  # Generated with: htpasswd -nb admin StrongPassword123 | base64
  auth: YWRtaW46JGFwcjEkSHo0SVZ2SkkkV3MuS0pLTi5oTHJBLmNnY3p2MkYvLgo=

---
# =============================================================================
# CONFIGMAP FOR CUSTOM NGINX CONFIGURATION
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-custom-config
  namespace: api-gateway
data:
  proxy-body-size: "50m"
  proxy-read-timeout: "60"
  proxy-send-timeout: "60"
  proxy-connect-timeout: "60"
  use-forwarded-headers: "true"
  compute-full-forwarded-for: "true"
  use-proxy-protocol: "false"
  enable-brotli: "true"
  brotli-level: "6"
  enable-real-ip: "true"
  server-tokens: "false"
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"

---
# =============================================================================
# MAIN API INGRESS
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-main-ingress
  namespace: api-gateway
  annotations:
    # Ingress class
    kubernetes.io/ingress.class: nginx
    
    # TLS configuration
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "1000"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    nginx.ingress.kubernetes.io/limit-whitelist: "10.0.0.0/8,172.16.0.0/12"
    
    # Request size limits
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "8k"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    
    # CORS configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://yourdomain.com,https://app.yourdomain.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-API-Key"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Content-Length,Content-Range,X-Request-ID"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-max-age: "86400"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
      add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
      
      # Add request ID for tracing
      set $request_id $request_id;
      if ($request_id = '') {
        set $request_id $pid-$msec-$remote_addr-$request_length;
      }
      add_header X-Request-ID $request_id always;

    # ModSecurity WAF (if enabled)
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecRequestBodyAccess On
      SecAuditLog /var/log/modsec_audit.log
      SecAuditLogFormat JSON

spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.yourdomain.com
      secretName: api-tls-secret
  rules:
    - host: api.yourdomain.com
      http:
        paths:
          # Main API endpoint
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: fastapi-service
                port:
                  number: 80
          
          # Health check endpoint (no auth)
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: fastapi-service
                port:
                  number: 80
          
          # Metrics endpoint (internal only)
          - path: /metrics
            pathType: Prefix
            backend:
              service:
                name: fastapi-service
                port:
                  number: 80

---
# =============================================================================
# ADMIN INGRESS WITH BASIC AUTH
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-admin-ingress
  namespace: api-gateway
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    
    # Basic authentication
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required - Admin Area"
    
    # Stricter rate limiting for admin
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/limit-connections: "5"
    
    # IP whitelist for admin access
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,192.168.0.0/16"

spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - api.yourdomain.com
      secretName: api-tls-secret
  rules:
    - host: api.yourdomain.com
      http:
        paths:
          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: admin-service
                port:
                  number: 80

---
# =============================================================================
# NETWORK POLICY FOR INGRESS
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-traffic
  namespace: api-gateway
spec:
  podSelector:
    matchLabels:
      app: fastapi
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000
